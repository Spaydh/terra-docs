"use strict";(self.webpackChunkterra_docs=self.webpackChunkterra_docs||[]).push([[659],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=l(n),h=r,m=p["".concat(c,".").concat(h)]||p[h]||d[h]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=p;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},4852:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return u},default:function(){return p}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={},c="Architecture",l={unversionedId:"internals/architecture",id:"internals/architecture",isDocsHomePage:!1,title:"Architecture",description:"Architecture of stLuna and bLuna",source:"@site/docs/internals/architecture.md",sourceDirName:"internals",slug:"/internals/architecture",permalink:"/internals/architecture",editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/internals/architecture.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Tokens: stLuna and bLuna",permalink:"/contracts/stLuna_and_bLuna"},next:{title:"Exchange Rates",permalink:"/internals/exchange-rates"}},u=[{value:"General overview",id:"general-overview",children:[]},{value:"Rewards Processing",id:"rewards-processing",children:[]},{value:"Conversions",id:"conversions",children:[]}],d={toc:u};function p(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"architecture"},"Architecture"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Architecture of stLuna and bLuna",src:n(4073).Z})),(0,o.kt)("h2",{id:"general-overview"},"General overview"),(0,o.kt)("p",null,"The Lido Liquid Staking for Terra implementation consists of the following contracts:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"The Hub contract.")," ",(0,o.kt)("a",{parentName:"li",href:"/contracts/hub"},"The Hub contract")," acts as the central hub for all minted stLuna and bLuna. Native Luna tokens received from users are delegated from here, and undelegations from bLuna unbond requests are also handled from this contract. Rewards generated from delegations are withdrawn to the ",(0,o.kt)("a",{parentName:"li",href:"/contracts/rewards_dispatcher"},"Rewards Dispatcher contract"),";"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"The stLuna Token contract.")," A Cw20 constant balance token (not rebasable) that handles balances and transfers. Note that all amounts are handled as ",(0,o.kt)("inlineCode",{parentName:"li"},"Uint128")," (128-bit integers with JSON string representation). Only the Hub contract is authorized to mint new tokens;"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"The bLuna Token contract.")," A Cw20 constant balance token (not rebasable) that handles balances and transfers. Note that all amounts are handled as ",(0,o.kt)("inlineCode",{parentName:"li"},"Uint128")," (128-bit integers with JSON string representation). Only the Hub contract is authorized to mint new tokens. The ",(0,o.kt)("inlineCode",{parentName:"li"},"IncreaseBalance")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"DecreaseBalance")," messages trigger user index updates in ",(0,o.kt)("a",{parentName:"li",href:"/contracts/reward"},"the bLuna Rewards contract"),";"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"The Rewards Dispatcher contract.")," Hub's staking rewards are claimed in various native token denominations ","(","TerraUSD, TerraSDR, Luna, etc.",")"," to the Reward Dispatcher's address. The Rewards Dispatcher then distributes the rewards between stLuna and bLuna (see below);"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"The bLuna Reward contract.")," The Reward contract contains logic for distributing Luna delegation rewards to holders of bLuna. After the bLuna share of delegation rewards is sent to the bLuna Reward contract in UST, they can then be distributed to bLuna holders. Holders of bLuna can then send a request to this contract to claim their accrued rewards. The Reward contract also stores the balance and reward index values for all bLuna holders, which is used to calculate the amount of bLuna rewards that a specific holder has accrued.")),(0,o.kt)("h2",{id:"rewards-processing"},"Rewards Processing"),(0,o.kt)("p",null,"Hub's staking rewards are claimed in various native token denominations ","(","TerraUSD, TerraSDR, Luna, etc.",")"," to the Reward Dispatcher's address. After that, the Hub sends the ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapToRewardDenom")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"DispatchRewards")," messages to the Rewards Dispatcher contract. The ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapToRewardDenom")," message contains two fields, ",(0,o.kt)("inlineCode",{parentName:"p"},"bluna_total_bond_amount")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"stluna_total_bond_amount"),". The rewards are distributed between stLuna and bLuna according to the ",(0,o.kt)("inlineCode",{parentName:"p"},"bluna_total_bond_amount / stluna_total_bond_amount"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"All non-Luna and non-UST rewards are swapped to UST;"),(0,o.kt)("li",{parentName:"ol"},"Depending on how the obtained Luna to UST rewards ratio corresponds to the target ",(0,o.kt)("inlineCode",{parentName:"li"},"bluna_total_bond_amount / stluna_total_bond_amount")," ratio, either the required amount of Luna is swapped to UST, or the required amount of UST is swapped to Luna.")),(0,o.kt)("p",null,"After the rewards are swapped to target denominations, the ",(0,o.kt)("inlineCode",{parentName:"p"},"DispatchRewards")," message is processed, where the Lido operating costs fee is applied to both stLuna and bLuna rewards."),(0,o.kt)("h2",{id:"conversions"},"Conversions"),(0,o.kt)("p",null,"At any moment, a user can convert their bLuna to stLuna and vice versa by sending a ",(0,o.kt)("inlineCode",{parentName:"p"},"Send")," message to either contract and specifying the Hub contract as the recipient. The Hub contract will then calculate and mint the required amount of the corresponding token using the current exchange rates."))}p.isMDXComponent=!0},4073:function(e,t,n){t.Z=n.p+"assets/images/architecture-a3fd8c273e443efa5b092913931bb6e1.png"}}]);